<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Framework PDF</title>
    <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1 class="app-title">Framework PDF</h1>
        </div>
        
        <div class="sidebar-footer">
            <button class="clearAll-btn" onclick="clearChat()">üóëÔ∏è Limpar conversa</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="model-selector">
                <label for="modelSelect">Modelo:</label>
                <select id="modelSelect">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                    <option value="llama3.1:8b">LLaMA 3.1</option>
                    <option value="deepseek-r1:8b">DeepSeek R1</option>
                    <option value="all">Todos os Modelos</option>
                </select>
            </div>
        </header>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <!-- Mensagens aparecem aqui -->
                <div class="welcome-message">
                    <h2>Bem-vindo ao Framework PDF</h2>
                    <p>Envie um PDF para come√ßar a fazer perguntas</p>
                    <label class="file-upload-label">
                        <input type="file" id="fileInput" accept=".pdf" onchange="handleFileUpload()" />
                        <span>üìé Anexar PDF</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area" id="inputArea" style="display: none;">
            <div class="input-wrapper">
                <textarea
                    id="questionInput" 
                    placeholder="Digite sua pergunta..." 
                    rows="1"
                ></textarea>
                <button type="submit" class="send-btn" onclick="sendQuestion()">
                    <span>Enviar</span>
                </button>
            </div>
        </div>
    </main>

    <script>
        const textarea = document.getElementById("questionInput");

        textarea.addEventListener("keydown", function (event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendQuestion();
            }
        });

        // Carrega mensagens do localStorage ao iniciar
        let messages = JSON.parse(localStorage.getItem('messages')) || [];

        function loadMessages() {
            const container = document.getElementById('messagesContainer');
            const inputArea = document.getElementById('inputArea');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="welcome-message">
                        <h2>Bem-vindo ao Framework PDF</h2>
                        <p>Envie um PDF para come√ßar a fazer perguntas</p>
                        <label class="file-upload-label">
                            <input type="file" id="fileInput" accept=".pdf" onchange="handleFileUpload()" />
                            <span>üìé Anexar PDF</span>
                        </label>
                    </div>
                `;
                inputArea.style.display = 'none';
            } else {
                container.innerHTML = '';
                messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `message ${msg.role}`;
                    msgDiv.innerHTML = msg.content;
                    container.appendChild(msgDiv);
                });
                inputArea.style.display = 'flex';
            }
        }

        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/upload-pdf/', { method: 'POST', body: formData });
                if (res.ok) {
                    addMessage('system', `üìÑ PDF "${file.name}" carregado com sucesso! Voc√™ j√° pode fazer perguntas sobre o documento!`);
                    fileInput.value = '';
                }
            } catch (err) {
                addMessage('system', 'Erro ao enviar PDF');
            }
        }

        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            if (!question) return;

            addMessage('user', question);
            input.value = '';

            const model = document.getElementById('modelSelect').value;
            const formData = new FormData();
            formData.append('question', question);
            formData.append('model', model);

            addMessage('system', 'Processando...');

            try {
                const res = await fetch('/chat/ask', { method: 'POST', body: formData });
                const data = await res.json();
                removeLastMessage();
                addMessage('assistant', data.answer || data.error);
            } catch (err) {
                removeLastMessage();
                addMessage('assistant', 'Erro na comunica√ß√£o com o servidor');
            }
        }

        function addMessage(role, content) {
            messages.push({ role, content });
            localStorage.setItem('messages', JSON.stringify(messages));

            const container = document.getElementById('messagesContainer');
            const inputArea = document.getElementById('inputArea');
            
            if (container.innerHTML.includes('welcome-message')) {
                container.innerHTML = '';
            }

            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            msgDiv.innerHTML = content;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            
            // Mostra o input se houver mensagens
            if (messages.length > 0) {
                inputArea.style.display = 'flex';
            }
        }

        function removeLastMessage() {
            const container = document.getElementById('messagesContainer');
            const messageElements = container.querySelectorAll('.message');
            if (messageElements.length > 0) {
                messageElements[messageElements.length - 1].remove();
                messages.pop();
                localStorage.setItem('messages', JSON.stringify(messages));
            }
        }

        async function clearChat() {
            // Limpa mensagens do frontend
            messages = [];
            localStorage.removeItem('messages');
            
            // Limpa contexto do PDF no backend
            try {
                await fetch('/clear-context/', { method: 'POST' });
            } catch (err) {
                console.error('Erro ao limpar contexto:', err);
            }
            
            loadMessages();
        }

        // Carrega mensagens ao iniciar
        loadMessages();
    </script>
</body>
</html>