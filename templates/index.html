<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Framework PDF</title>

    <!-- CSS externo -->
    <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>

    <!--  SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1 class="app-title">Framework PDF</h1>
        </div>
        
        <!-- Bot√£o que reseta a conversa -->
        <button class="new-chat-btn" onclick="resetChat()">
            <span class="plus-icon">+</span> Nova Conversa
        </button>

        <div class="sidebar-footer">
            <!-- Faz a mesma coisa que o bot√£o acima -->
            <button class="clearAll-btn" onclick="resetChat()">üóëÔ∏è Apagar conversa</button>
        </div>
    </aside>


    <!-- ==================== √ÅREA PRINCIPAL ==================== -->
    <main class="main-content">

        <!-- Barra superior com sele√ß√£o de modelo -->
        <header class="top-bar">
            <div class="model-selector">
                <label for="modelSelect">Modelo:</label>
                <select id="modelSelect">
                    <!-- Cada value ser√° enviado ao backend -->
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                    <option value="llama3.1:8b">LLaMA 3.1</option>
                    <option value="deepseek-r1:8b">DeepSeek R1</option>
                    <option value="all">Todos os Modelos</option>
                </select>
            </div>
        </header>

        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <!-- Mensagem inicial exibida quando n√£o h√° conversa -->
                <div class="welcome-message">
                    <h2>Bem-vindo ao Framework PDF</h2>
                    <p>Envie um PDF para come√ßar a fazer perguntas</p>

                    <!-- Entrada de arquivo PDF -->
                    <label class="file-upload-label">
                        <input type="file" id="fileInput" accept=".pdf" onchange="handleFileUpload()" />
                        <span>üìé Anexar PDF</span>
                    </label>
                </div>
            </div>
        </div>


        <!-- √ÅREA DE ENTRADA DO USU√ÅRIO  -->
        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="questionInput" placeholder="Digite sua pergunta..." rows="1"></textarea>
                <button type="submit" class="send-btn" onclick="sendQuestion()">
                    <span>Enviar</span>
                </button>
            </div>
        </div>
    </main>


    <!--  FUN√á√ïES JS  -->
    <script>
        const textarea = document.getElementById("questionInput");

        /* ENVIAR RESPOSTA COM ENTER OU NO BOT√ÉO */
        textarea.addEventListener("keydown", function (event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendQuestion();
            }
        });


        /* LIMPAR JANELA E VOLTAR PARA TELA INICIAL */
        function resetChat() {
            document.getElementById("messagesContainer").innerHTML = `
                <div class="welcome-message">
                    <h2>Bem-vindo ao Framework PDF</h2>
                    <p>Envie um PDF para come√ßar a fazer perguntas</p>
                    <label class="file-upload-label">
                        <input type="file" id="fileInput" accept=".pdf" onchange="handleFileUpload()" />
                        <span>üìé Anexar PDF</span>
                    </label>
                </div>`;
        }

        /* ENVIAR O PDF PARA O BACKEND */
        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/upload-pdf/', { method: 'POST', body: formData });

                if (res.ok) {
                    addMessage('system', `üìÑ PDF "${file.name}" carregado com sucesso!`);
                    fileInput.value = '';
                }
            } catch {
                addMessage('system', 'Erro ao enviar PDF');
            }
        }


        /* ==================== FUN√á√ÉO: addMessage ====================
           Adiciona mensagens na tela (usu√°rio, sistema ou IA)
        =========================================================== */
        function addMessage(role, content) {
            const container = document.getElementById('messagesContainer');

            // Remove mensagem inicial se ainda estiver l√°
            if (container.innerHTML.includes('welcome-message')) {
                container.innerHTML = '';
            }

            // Cria o elemento da mensagem
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            msgDiv.innerHTML = content;

            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }


        /* ==================== removeLastMessage ====================
           Usado para remover "Processando..." antes de mostrar a resposta
        =========================================================== */
        function removeLastMessage() {
            const container = document.getElementById('messagesContainer');
            const msgs = container.querySelectorAll('.message');
            if (msgs.length > 0) msgs[msgs.length - 1].remove();
        }


        /* ==================== FUN√á√ÉO: sendQuestion ====================
           Envia a pergunta ao backend e exibe a resposta
        =========================================================== */
        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            if (!question) return;

            addMessage('user', question); // Exibe a pergunta
            input.value = '';

            const model = document.getElementById('modelSelect').value;

            // Monta o formul√°rio que ser√° enviado
            const formData = new FormData();
            formData.append('question', question);
            formData.append('model', model);

            addMessage('system', 'Processando...');

            try {
                const res = await fetch('/chat/ask', { method: 'POST', body: formData });
                const data = await res.json();

                removeLastMessage(); // Remove "Processando..."

                addMessage('assistant', data.answer || data.error);

            } catch (err) {
                removeLastMessage();
                addMessage('assistant', 'Erro na comunica√ß√£o com o servidor');
            }
        }

    </script>

</body>
</html>